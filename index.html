<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Loyers Simple</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-up-to-date { background: #d1fae5; }
        .status-soon-due { background: #fef3c7; }
        .status-late { background: #fee2e2; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-blue-600 p-8 text-white text-center">
                <i class="fas fa-home text-5xl mb-4"></i>
                <h1 class="text-3xl font-bold">Gestion Loyers</h1>
                <p class="text-blue-100 mt-2">Version Simplifiée</p>
            </div>
            
            <div class="p-8">
                <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg mb-6">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="errorMessage"></span>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        <i class="fas fa-user mr-2"></i>Nom d'utilisateur
                    </label>
                    <input type="text" id="loginUsername" 
                           class="w-full p-3 border border-gray-300 rounded-lg"
                           placeholder="admin">
                </div>
                
                <div class="mb-8">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        <i class="fas fa-lock mr-2"></i>Mot de passe
                    </label>
                    <input type="password" id="loginPassword" 
                           class="w-full p-3 border border-gray-300 rounded-lg"
                           placeholder="admin123">
                </div>
                
                <button onclick="login()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg font-semibold text-lg">
                    <i class="fas fa-sign-in-alt mr-3"></i>Se connecter
                </button>
                
                <div class="mt-6 text-center text-sm text-gray-500">
                    <p>Identifiants par défaut: admin / admin123</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg p-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Gestion Loyers</h1>
                    <p class="text-gray-600">Bienvenue, <span id="userName"></span></p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="showSection('dashboard')" class="text-gray-600 hover:text-blue-600">
                        <i class="fas fa-chart-bar text-xl"></i>
                    </button>
                    <button onclick="showSection('properties')" class="text-gray-600 hover:text-blue-600">
                        <i class="fas fa-home text-xl"></i>
                    </button>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4">
            <!-- Dashboard Section -->
            <div id="dashboardSection">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Logements</h3>
                        <p id="totalProperties" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Revenu Mensuel</h3>
                        <p id="totalRent" class="text-3xl font-bold text-green-600">0 FCFA</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Actions</h3>
                        <button onclick="showAddPropertyModal()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full">
                            <i class="fas fa-plus mr-2"></i>Nouveau logement
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Derniers logements</h2>
                    <div id="recentProperties"></div>
                </div>
            </div>

            <!-- Properties Section -->
            <div id="propertiesSection" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Tous les logements</h2>
                    <button onclick="showAddPropertyModal()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Ajouter
                    </button>
                </div>

                <div id="propertiesList"></div>
            </div>

            <!-- Users Management (Admin only) -->
            <div id="usersSection" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Gestion des utilisateurs</h2>
                    <button onclick="showAddUserModal()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-user-plus mr-2"></i>Nouvel utilisateur
                    </button>
                </div>
                <div id="usersList"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Nouveau logement</h3>
            <form id="addPropertyForm" onsubmit="saveProperty(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Nom du logement *</label>
                        <input type="text" id="propertyName" required class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Adresse</label>
                        <input type="text" id="propertyAddress" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Locataire *</label>
                        <input type="text" id="propertyTenant" required class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Loyer mensuel (FCFA) *</label>
                        <input type="number" id="propertyRent" required class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Date de début *</label>
                        <input type="date" id="propertyStartDate" required class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Notes</label>
                        <textarea id="propertyNotes" rows="3" class="w-full p-2 border rounded"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" onclick="hideModal('addPropertyModal')" class="px-4 py-2 border rounded">
                        Annuler
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Enregistrer un paiement</h3>
            <div id="paymentForm"></div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Nouvel utilisateur</h3>
            <form onsubmit="addUser(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Nom complet *</label>
                        <input type="text" id="newUserName" required class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Nom d'utilisateur *</label>
                        <input type="text" id="newUserUsername" required class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Mot de passe *</label>
                        <input type="password" id="newUserPassword" required class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="newUserIsAdmin" class="mr-2">
                            <span>Administrateur</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" onclick="hideModal('addUserModal')" class="px-4 py-2 border rounded">
                        Annuler
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">
                        Créer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentUser = null;

        // Login simple
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Identifiants incorrects');
                }
                
                currentUser = data.user;
                
                // Cacher login, afficher app
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('userName').textContent = currentUser.full_name;
                
                // Charger le dashboard
                loadDashboard();
                
            } catch (error) {
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('app').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showSection(sectionName) {
            // Cacher toutes les sections
            ['dashboardSection', 'propertiesSection', 'usersSection'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            // Afficher la section demandée
            document.getElementById(sectionName).classList.remove('hidden');
            
            // Charger les données
            if (sectionName === 'dashboardSection') loadDashboard();
            if (sectionName === 'propertiesSection') loadProperties();
            if (sectionName === 'usersSection' && currentUser.is_admin) loadUsers();
        }

        async function loadDashboard() {
            try {
                const auth = btoa(`${currentUser.username}:${currentUser.password}`);
                const response = await fetch(`${API_BASE}/api/dashboard`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });
                
                const data = await response.json();
                
                document.getElementById('totalProperties').textContent = data.totalProperties;
                document.getElementById('totalRent').textContent = data.totalMonthlyRent.toLocaleString() + ' FCFA';
                
                // Afficher les derniers logements
                const recent = data.properties.slice(0, 5);
                document.getElementById('recentProperties').innerHTML = recent.map(prop => `
                    <div class="border-b py-3">
                        <div class="flex justify-between">
                            <div>
                                <h4 class="font-semibold">${prop.name}</h4>
                                <p class="text-sm text-gray-600">${prop.tenant_name}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">${prop.monthly_rent?.toLocaleString()} FCFA</p>
                                <p class="text-sm text-gray-600">${prop.months_paid || 0} mois payés</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadProperties() {
            try {
                const auth = btoa(`${currentUser.username}:${currentUser.password}`);
                const response = await fetch(`${API_BASE}/api/properties`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });
                
                const properties = await response.json();
                
                document.getElementById('propertiesList').innerHTML = properties.map(prop => `
                    <div class="bg-white rounded-lg shadow p-6 mb-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold">${prop.name}</h3>
                                <p class="text-gray-600">${prop.address}</p>
                                <p class="mt-2"><strong>Locataire:</strong> ${prop.tenant_name}</p>
                                <p><strong>Loyer:</strong> ${prop.monthly_rent?.toLocaleString()} FCFA</p>
                                <p><strong>Mois payés:</strong> ${prop.months_paid || 0}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="showPaymentModal(${prop.id})" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-money-bill mr-1"></i>Paiement
                                </button>
                                ${currentUser.is_admin ? `
                                    <button onclick="deleteProperty(${prop.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function showAddPropertyModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('propertyStartDate').value = today;
            showModal('addPropertyModal');
        }

        async function saveProperty(event) {
            event.preventDefault();
            
            const property = {
                name: document.getElementById('propertyName').value,
                address: document.getElementById('propertyAddress').value,
                tenant_name: document.getElementById('propertyTenant').value,
                monthly_rent: parseInt(document.getElementById('propertyRent').value),
                start_date: document.getElementById('propertyStartDate').value,
                notes: document.getElementById('propertyNotes').value
            };
            
            try {
                const auth = btoa(`${currentUser.username}:${currentUser.password}`);
                const response = await fetch(`${API_BASE}/api/properties`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${auth}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(property)
                });
                
                if (response.ok) {
                    hideModal('addPropertyModal');
                    alert('Logement créé avec succès!');
                    loadDashboard();
                    showSection('propertiesSection');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la création');
            }
        }

        function showPaymentModal(propertyId) {
            document.getElementById('paymentForm').innerHTML = `
                <form onsubmit="recordPayment(event, ${propertyId})">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Nombre de mois payés</label>
                        <input type="number" id="paymentMonths" min="1" max="12" required 
                               class="w-full p-2 border rounded" value="1">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 mb-2">Notes (optionnel)</label>
                        <textarea id="paymentNotes" rows="3" class="w-full p-2 border rounded"></textarea>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" onclick="hideModal('paymentModal')" class="px-4 py-2 border rounded">
                            Annuler
                        </button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">
                            Enregistrer
                        </button>
                    </div>
                </form>
            `;
            showModal('paymentModal');
        }

        async function recordPayment(event, propertyId) {
            event.preventDefault();
            
            const months = parseInt(document.getElementById('paymentMonths').value);
            const notes = document.getElementById('paymentNotes').value;
            
            try {
                const auth = btoa(`${currentUser.username}:${currentUser.password}`);
                const response = await fetch(`${API_BASE}/api/properties/${propertyId}/payment`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${auth}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ months, notes })
                });
                
                if (response.ok) {
                    hideModal('paymentModal');
                    alert('Paiement enregistré avec succès!');
                    loadProperties();
                    loadDashboard();
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'enregistrement');
            }
        }

        async function deleteProperty(propertyId) {
            if (!confirm('Supprimer ce logement ?')) return;
            
            try {
                const auth = btoa(`${currentUser.username}:${currentUser.password}`);
                const response = await fetch(`${API_BASE}/api/properties/${propertyId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Basic ${auth}` }
                });
                
                if (response.ok) {
                    alert('Logement supprimé');
                    loadProperties();
                    loadDashboard();
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression');
            }
        }

        // Gestion des utilisateurs (admin seulement)
        async function loadUsers() {
            if (!currentUser.is_admin) return;
            
            try {
                const auth = btoa(`${currentUser.username}:${currentUser.password}`);
                const response = await fetch(`${API_BASE}/api/users`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });
                
                const users = await response.json();
                
                document.getElementById('usersList').innerHTML = users.map(user => `
                    <div class="bg-white rounded-lg shadow p-4 mb-3">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold">${user.full_name}</h4>
                                <p class="text-gray-600">${user.username}</p>
                                <span class="text-sm px-2 py-1 rounded ${user.is_admin ? 'bg-blue-100 text-blue-800' : 'bg-gray-100'}">
                                    ${user.is_admin ? 'Admin' : 'Utilisateur'}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function showAddUserModal() {
            showModal('addUserModal');
        }

        async function addUser(event) {
            event.preventDefault();
            
            const user = {
                full_name: document.getElementById('newUserName').value,
                username: document.getElementById('newUserUsername').value,
                password: document.getElementById('newUserPassword').value,
                is_admin: document.getElementById('newUserIsAdmin').checked
            };
            
            try {
                const auth = btoa(`${currentUser.username}:${currentUser.password}`);
                const response = await fetch(`${API_BASE}/api/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${auth}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(user)
                });
                
                if (response.ok) {
                    hideModal('addUserModal');
                    alert('Utilisateur créé avec succès!');
                    loadUsers();
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la création');
            }
        }

        // Fonctions utilitaires
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Auto-login pour test
        window.addEventListener('load', () => {
            // Pré-remplir pour test
            document.getElementById('loginUsername').value = 'admin';
            document.getElementById('loginPassword').value = 'admin123';
        });
    </script>
</body>
</html>